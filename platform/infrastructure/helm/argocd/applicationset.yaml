# Vision AI Platform - Unified ArgoCD ApplicationSet
# Deploys the entire platform (backend, frontend, training-infra) per environment
# Uses JFrog Helm repository with token authentication
#
# Multi-source pattern:
#   - Chart: JFrog Helm repo
#   - Values: Git repo (environment-specific)
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: vision-ai-platform
  namespace: argocd
spec:
  generators:
    - list:
        elements:
          - env: dev
            namespace: vision-ai-dev
            cluster: https://kubernetes.default.svc
            chartVersion: "1.0.0"
          - env: staging
            namespace: vision-ai-staging
            cluster: https://kubernetes.default.svc
            chartVersion: "1.0.0"
          - env: prod
            namespace: vision-ai-prod
            cluster: https://kubernetes.default.svc
            chartVersion: "1.0.0"
  template:
    metadata:
      name: "vision-ai-platform-{{env}}"
      labels:
        app.kubernetes.io/part-of: vision-ai-platform
        environment: "{{env}}"
    spec:
      project: vision-ai
      # Multi-source: Chart from Helm repo + Values from Git
      sources:
        # Source 1: Helm Chart from JFrog
        - repoURL: https://your-company.jfrog.io/artifactory/helm-local
          chart: vision-ai-platform
          targetRevision: "{{chartVersion}}"
          helm:
            valueFiles:
              # Reference values file from source 2 (Git repo)
              - $values/platform/infrastructure/helm/environments/{{env}}/values.yaml

        # Source 2: Values files from Git (referenced as $values)
        - repoURL: https://github.com/your-org/vision-ai-platform-config.git
          targetRevision: main
          ref: values

      destination:
        server: "{{cluster}}"
        namespace: "{{namespace}}"
      syncPolicy:
        automated:
          prune: true
          selfHeal: true
        syncOptions:
          - CreateNamespace=true
          - PrunePropagationPolicy=foreground
        retry:
          limit: 5
          backoff:
            duration: 5s
            factor: 2
            maxDuration: 3m
---
# JFrog Helm Repository Credentials
# Apply this secret FIRST before deploying ApplicationSet:
#   kubectl apply -f argocd-jfrog-secret.yaml
#
# For production, use External Secrets Operator or Sealed Secrets
apiVersion: v1
kind: Secret
metadata:
  name: jfrog-helm-repo
  namespace: argocd
  labels:
    argocd.argoproj.io/secret-type: repository
type: Opaque
stringData:
  type: helm
  name: jfrog-helm
  url: https://your-company.jfrog.io/artifactory/helm-local
  # Token authentication (recommended)
  username: ""
  password: "YOUR_JFROG_TOKEN_HERE"
