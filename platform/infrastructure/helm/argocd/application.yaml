# Vision AI Platform - ArgoCD Application
# Single chart deployment from JFrog Helm repo
#
# Prerequisites:
#   1. Apply secret first: kubectl apply -f secret.yaml
#   2. Apply project: kubectl apply -f project.yaml
#   3. Apply this application: kubectl apply -f application.yaml
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: vision-ai-platform
  namespace: argocd
spec:
  project: vision-ai
  source:
    repoURL: https://your-company.jfrog.io/artifactory/helm-local
    chart: vision-ai-platform
    targetRevision: "1.0.0"
    helm:
      values: |
        # ===========================================
        # Backend Configuration
        # ===========================================
        backend:
          enabled: true
          replicaCount: 1

          image:
            repository: your-registry/vision-ai-backend
            tag: "latest"

          env:
            # Database
            DATABASE_URL: "postgresql://user:password@postgres-host:5432/vision_ai"
            # Redis
            REDIS_URL: "redis://redis-host:6379"
            # Storage (S3/MinIO)
            S3_ENDPOINT: "https://s3.your-company.com"
            S3_BUCKET: "vision-ai-prod"
            # Temporal
            TEMPORAL_HOST: "temporal-host:7233"
            TEMPORAL_NAMESPACE: "default"
            # Application
            ENVIRONMENT: "production"
            LOG_LEVEL: "INFO"
            CORS_ORIGINS: "https://vision-ai.your-company.com"

          # Secrets from K8s Secret (create separately)
          secretEnv:
            - name: AWS_ACCESS_KEY_ID
              secretName: vision-ai-secrets
              secretKey: aws-access-key
            - name: AWS_SECRET_ACCESS_KEY
              secretName: vision-ai-secrets
              secretKey: aws-secret-key
            - name: OPENAI_API_KEY
              secretName: vision-ai-secrets
              secretKey: openai-api-key
            - name: JWT_SECRET
              secretName: vision-ai-secrets
              secretKey: jwt-secret

        # ===========================================
        # Frontend Configuration
        # ===========================================
        frontend:
          enabled: true
          replicaCount: 2

          image:
            repository: your-registry/vision-ai-frontend
            tag: "latest"

          env:
            NEXT_PUBLIC_API_URL: "https://vision-ai.your-company.com/api/v1"
            NEXT_PUBLIC_WS_URL: "wss://vision-ai.your-company.com/ws"
            NEXT_PUBLIC_ENVIRONMENT: "production"

        # ===========================================
        # Training Infrastructure
        # ===========================================
        training:
          enabled: true
          namespace: vision-ai-training

          registry:
            url: your-registry
            defaultTag: "latest"

  destination:
    server: https://kubernetes.default.svc
    namespace: vision-ai
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
