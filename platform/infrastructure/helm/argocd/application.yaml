# Vision AI Platform - ArgoCD Application
# Single chart deployment from JFrog Helm repo
#
# Prerequisites:
#   1. Apply secret first: kubectl apply -f secret.yaml
#   2. Apply project: kubectl apply -f project.yaml
#   3. Apply this application: kubectl apply -f application.yaml
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: vision-ai-platform
  namespace: argocd
spec:
  project: vision-ai
  source:
    repoURL: https://your-company.jfrog.io/artifactory/helm-local
    chart: vision-ai-platform
    targetRevision: "1.0.0"
    helm:
      values: |
        # ===========================================
        # Backend Configuration
        # ===========================================
        backend:
          enabled: true
          replicaCount: 1

          image:
            repository: your-registry/vision-ai-backend
            tag: "latest"

          env:
            # --- LLM API ---
            LLM_PROVIDER: "openai"
            OPENAI_API_KEY: "your-openai-api-key"
            OPENAI_BASE_URL: "https://api.openai.com/v1"
            LLM_MODEL: "gpt-4o-mini"
            # GOOGLE_API_KEY: ""  # for gemini provider

            # --- Database ---
            DATABASE_URL: "postgresql://user:password@postgres-host:5432/platform"
            USER_DATABASE_URL: "postgresql://user:password@postgres-host:5432/users"

            # --- Redis ---
            REDIS_URL: "redis://redis-host:6379/0"

            # --- Temporal ---
            TEMPORAL_HOST: "temporal-host:7233"
            TEMPORAL_NAMESPACE: "default"

            # --- Paths ---
            UPLOAD_DIR: "/app/data/uploads"
            OUTPUT_DIR: "/app/data/outputs"
            MODEL_DIR: "/app/data/models"
            LOG_DIR: "/app/data/logs"

            # --- Backend API ---
            BACKEND_PORT: "8000"
            # API_BASE_URL is auto-generated by Helm (K8s FQDN)

            # --- Training Defaults ---
            DEFAULT_EPOCHS: "50"
            DEFAULT_BATCH_SIZE: "32"
            DEFAULT_LEARNING_RATE: "0.001"

            # --- Labeler Service ---
            LABELER_API_URL: "http://labeler-service:8011"
            LABELER_SERVICE_KEY: "your-labeler-service-key"

            # --- Internal Storage (MinIO) ---
            INTERNAL_STORAGE_ENDPOINT: "http://minio-internal:9000"
            INTERNAL_STORAGE_ACCESS_KEY: "your-access-key"
            INTERNAL_STORAGE_SECRET_KEY: "your-secret-key"
            INTERNAL_BUCKET_WEIGHTS: "model-weights"
            INTERNAL_BUCKET_CHECKPOINTS: "training-checkpoints"
            INTERNAL_BUCKET_SCHEMAS: "config-schemas"

            # --- External Storage (S3/R2/MinIO) ---
            EXTERNAL_STORAGE_ENDPOINT: "https://your-account-id.r2.cloudflarestorage.com"
            EXTERNAL_STORAGE_ACCESS_KEY: "your-r2-access-key"
            EXTERNAL_STORAGE_SECRET_KEY: "your-r2-secret-key"
            EXTERNAL_BUCKET_DATASETS: "training-datasets"

            # --- Legacy Storage (backward compatibility) ---
            AWS_S3_ENDPOINT_URL: "http://minio:9000"
            AWS_ACCESS_KEY_ID: "your-access-key"
            AWS_SECRET_ACCESS_KEY: "your-secret-key"
            S3_BUCKET_DATASETS: "training-datasets"

            # --- ClearML ---
            CLEARML_API_HOST: "http://clearml-api:8008"
            CLEARML_WEB_HOST: "http://clearml-web:8080"
            CLEARML_FILES_HOST: "http://clearml-files:8081"
            CLEARML_API_ACCESS_KEY: ""
            CLEARML_API_SECRET_KEY: ""

            # --- MLflow (Optional) ---
            MLFLOW_TRACKING_URI: "http://mlflow:5000"

            # --- Loki (Optional) ---
            LOKI_URL: "http://loki:3100"
            LOKI_ENABLED: "false"
            LOKI_HTTP_PORT: "3100"
            LOKI_GRPC_PORT: "9096"

            # --- Security & Authentication ---
            JWT_SECRET: "your-jwt-secret-change-this"
            JWT_ALGORITHM: "HS256"
            ACCESS_TOKEN_EXPIRE_MINUTES: "60"
            REFRESH_TOKEN_EXPIRE_DAYS: "7"
            SERVICE_JWT_SECRET: "your-service-jwt-secret"

            # --- CORS ---
            CORS_ORIGINS: "https://vision-ai.your-company.com"
            FRONTEND_URL: "https://vision-ai.your-company.com"

            # --- Logging ---
            LOG_LEVEL: "INFO"
            LOG_FORMAT: "json"

            # --- Environment ---
            DEBUG: "False"
            ENVIRONMENT: "production"

            # --- Training Execution ---
            TRAINING_MODE: "kubernetes"
            USE_UV: "false"
            USE_GPU: "true"
            CUDA_VISIBLE_DEVICES: "0"

            # --- Kubernetes Job Resources ---
            K8S_GPU_COUNT: "1"
            K8S_MEMORY_LIMIT: "16Gi"
            K8S_MEMORY_REQUEST: "8Gi"
            K8S_CPU_LIMIT: "4"
            K8S_CPU_REQUEST: "2"

        # ===========================================
        # Frontend Configuration
        # ===========================================
        frontend:
          enabled: true
          replicaCount: 2

          image:
            repository: your-registry/vision-ai-frontend
            tag: "latest"

          env:
            NEXT_PUBLIC_API_URL: "https://vision-ai.your-company.com/api/v1"
            NEXT_PUBLIC_WS_URL: "wss://vision-ai.your-company.com/ws"
            NEXT_PUBLIC_ENVIRONMENT: "production"

        # ===========================================
        # Training Infrastructure
        # ===========================================
        training:
          enabled: true
          namespace: vision-ai-training

          registry:
            url: your-registry
            defaultTag: "latest"

  destination:
    server: https://kubernetes.default.svc
    namespace: vision-ai
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
