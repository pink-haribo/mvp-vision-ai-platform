version: '3.8'

# ================================
# Vision AI Platform - Development Services
# ================================
# This extends the base docker-compose.yml with application services
# (Backend, Training Service, Frontend) for local development.
#
# Usage:
#   docker-compose -f docker-compose.yml -f docker-compose.dev.yml up -d
#   docker-compose -f docker-compose.yml -f docker-compose.dev.yml logs -f backend
#   docker-compose -f docker-compose.yml -f docker-compose.dev.yml down

services:
  # ================================
  # Backend API
  # ================================
  backend:
    build:
      context: .
      dockerfile: mvp/backend/Dockerfile
    container_name: vision-backend
    restart: unless-stopped
    ports:
      - "8000:8000"
    environment:
      # Database
      - DATABASE_URL=sqlite:///./data/db/vision_platform.db

      # LLM APIs
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}

      # Object Storage (R2 for production, MinIO for local dev)
      - AWS_S3_ENDPOINT_URL=${AWS_S3_ENDPOINT_URL:-http://minio:9000}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID:-minioadmin}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY:-minioadmin}
      - S3_BUCKET=${S3_BUCKET:-vision-platform-dev}

      # Training Service
      - TRAINING_SERVICE_URL=http://training-service:8001

      # MLflow
      - MLFLOW_TRACKING_URI=http://mlflow:5000

      # Other
      - ENVIRONMENT=development
      - LOG_LEVEL=INFO

    volumes:
      # Mount data directory for SQLite, outputs, logs
      - ./mvp/data:/app/data
      # Mount source code for hot reload (optional, comment out for production-like testing)
      - ./mvp/backend/app:/app/app

    depends_on:
      - minio
      - mlflow
      - training-service

    networks:
      - vision-network

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ================================
  # Training Service
  # ================================
  training-service:
    build:
      context: .
      dockerfile: mvp/training/Dockerfile
    container_name: vision-training-service
    restart: unless-stopped
    ports:
      - "8001:8001"
    environment:
      # Object Storage (R2 for production, MinIO for local dev)
      - AWS_S3_ENDPOINT_URL=${AWS_S3_ENDPOINT_URL:-http://minio:9000}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID:-minioadmin}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY:-minioadmin}
      - S3_BUCKET=${S3_BUCKET:-vision-platform-dev}

      # MLflow
      - MLFLOW_TRACKING_URI=http://mlflow:5000

      # Backend Internal API
      - BACKEND_INTERNAL_URL=http://backend:8000/internal
      - BACKEND_INTERNAL_AUTH_TOKEN=${BACKEND_INTERNAL_AUTH_TOKEN:-dev-internal-token-123}

      # Other
      - ENVIRONMENT=development
      - LOG_LEVEL=INFO

    volumes:
      # Mount workspace for training outputs, datasets cache
      - ./mvp/data:/workspace/data
      # Mount source code for hot reload (optional)
      - ./mvp/training/adapters:/app/adapters
      - ./mvp/training/platform_sdk:/app/platform_sdk

    depends_on:
      - minio
      - mlflow

    networks:
      - vision-network

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ================================
  # Frontend (Optional - for full stack development)
  # ================================
  frontend:
    build:
      context: .
      dockerfile: mvp/frontend/Dockerfile
      target: development
    container_name: vision-frontend
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      - NEXT_PUBLIC_API_URL=http://localhost:8000/api/v1
      - NEXT_PUBLIC_WS_URL=ws://localhost:8000/ws
      - NODE_ENV=development

    volumes:
      # Mount source code for hot reload
      - ./mvp/frontend:/app
      - /app/node_modules  # Use container's node_modules
      - /app/.next  # Use container's .next build cache

    depends_on:
      - backend

    networks:
      - vision-network

    profiles:
      - fullstack  # Only start with: docker-compose --profile fullstack up

# ================================
# Networks (reuse from base docker-compose.yml)
# ================================
networks:
  vision-network:
    external: true
    name: vision-network
