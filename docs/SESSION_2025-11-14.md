## [2025-11-14 18:30] Validation Callback System 구현 및 E2E 검증

### 논의 주제
- Frontend MLflow 메트릭 차트 동적 렌더링 리팩토링
- Backend Validation Callback API 엔드포인트 구현
- Ultralytics Trainer Validation 결과 처리 및 콜백 전송
- Dual Storage를 활용한 Validation 이미지 업로드
- E2E 테스트를 통한 전체 Validation 파이프라인 검증

### 주요 결정사항

#### 1. Frontend 동적 메트릭 렌더링 구조 ✅
**배경**:
- 기존: Hardcoded metric keys (train/box_loss, metrics/mAP50 등)
- 문제: 새 메트릭 추가 시 컴포넌트 수정 필요

**결정**:
- MLflow API에서 받은 메트릭 키를 기반으로 동적 차트 생성
- 메트릭 카테고리 자동 분류 (Training Loss, Validation Metrics, Learning Rate)
- 다양한 프레임워크 지원 (Ultralytics, timm, custom)

**구현** (`platform/frontend/components/training/MLflowMetricsCharts.tsx`):
```typescript
// 동적 메트릭 그룹핑
const categorizeMetric = (key: string) => {
  if (key.includes('train/') || key.includes('loss')) return 'Training Loss';
  if (key.includes('metrics/')) return 'Validation Metrics';
  if (key.includes('lr')) return 'Learning Rate';
  return 'Other';
};

// 자동 차트 생성
{categories[category].map(key => (
  <MetricChart key={key} metricKey={key} data={metricsData[key]} />
))}
```

**이점**:
- 프레임워크 무관 (Framework-agnostic)
- 신규 메트릭 자동 표시
- 유지보수 간소화

#### 2. Backend Validation Callback 엔드포인트 구조 ✅
**배경**:
- Frontend에서 ValidationDashboard 구현 완료
- Trainer가 Validation 결과를 Backend로 전송할 방법 필요

**결정**:
- `POST /api/v1/validation/jobs/{job_id}/results` 엔드포인트 추가
- Trainer → Backend 단방향 콜백
- 데이터베이스에 검증 결과 저장 (ValidationResult, ValidationImageResult)

**API 스키마** (`platform/backend/app/schemas/validation.py`):
```python
class ValidationCallbackRequest(BaseModel):
    job_id: int
    epoch: int
    task_type: str  # detection, segmentation, pose, classification

    # Metrics
    primary_metric_name: Optional[str]  # e.g., "mAP50-95"
    primary_metric_value: Optional[float]
    overall_loss: Optional[float]
    metrics: Optional[Dict[str, Any]]  # Task-specific metrics

    # Visualization
    class_names: Optional[List[str]]
    visualization_urls: Optional[Dict[str, str]]  # S3 URLs to plots
    confusion_matrix: Optional[List[List[int]]]

    # Per-image results (optional for small datasets)
    image_results: Optional[List[ValidationImageData]]
```

**엔드포인트 로직** (`platform/backend/app/api/validation.py:150-215`):
- Idempotent update-or-create 패턴 (같은 epoch 재전송 시 덮어쓰기)
- Transaction 내 ValidationResult + ValidationImageResult 동시 저장
- 로깅: `[VALIDATION CALLBACK]` prefix로 추적 용이

#### 3. Ultralytics Trainer Validation 처리 플로우 ✅
**배경**:
- Ultralytics는 학습 완료 후 자동으로 validation plots 생성
- 이 plots를 MinIO에 업로드하고 Backend에 콜백 전송 필요

**구현** (`platform/trainers/ultralytics/train.py:363-445`):

**Step 1: Validation Plots 수집**
```python
plots_dir = project_dir / "train"  # Ultralytics 기본 저장 위치
plot_files = {
    'confusion_matrix': 'confusion_matrix.png',
    'confusion_matrix_normalized': 'confusion_matrix_normalized.png',
    'f1_curve': 'F1_curve.png',
    'pr_curve': 'PR_curve.png',
    'p_curve': 'P_curve.png',
    'r_curve': 'R_curve.png',
}
```

**Step 2: MinIO Internal Storage 업로드**
```python
for plot_name, plot_file in plot_files.items():
    plot_path = plots_dir / plot_file
    if plot_path.exists():
        s3_key = f"job{job_id}/validation/{plot_file}"
        storage.internal_client.client.upload_file(
            str(plot_path),
            storage.internal_client.bucket,
            s3_key,
            ExtraArgs={'ContentType': 'image/png'}
        )
        visualization_urls[plot_name] = f"s3://{bucket}/{s3_key}"
```

**Step 3: 메타데이터 추출**
```python
# Class names from data.yaml
with open(data_yaml, 'r') as f:
    data_config = yaml.safe_load(f)
    class_names = data_config.get('names', [])

# Task type auto-detection
task_type = 'detection'  # Default
if 'seg' in model_name.lower():
    task_type = 'segmentation'
elif 'pose' in model_name.lower():
    task_type = 'pose'
elif 'cls' in model_name.lower():
    task_type = 'classification'
```

**Step 4: Validation Callback 전송**
```python
validation_data = {
    'job_id': int(job_id),
    'epoch': epochs,
    'task_type': task_type,
    'primary_metric_name': 'mAP50-95',
    'primary_metric_value': final_metrics.get('mAP50-95'),
    'metrics': final_metrics,
    'class_names': class_names,
    'visualization_urls': visualization_urls,
}

callback_client.send_validation_sync(job_id, validation_data)
```

#### 4. CallbackClient 동기/비동기 버전 통합 ✅
**배경**:
- Ultralytics callbacks는 동기(synchronous) 컨텍스트
- 기존 `send_validation()` 메서드는 async 함수

**문제**:
```python
# ❌ AsyncIO 이벤트 루프가 이미 실행 중이면 오류
await callback_client.send_validation(job_id, data)
# RuntimeError: This event loop is already running
```

**해결책** (`platform/trainers/ultralytics/utils.py:252-265`):
```python
@retry(stop=stop_after_attempt(3), wait=wait_exponential(multiplier=1, min=2, max=10))
def send_validation_sync(self, job_id: str, data: Dict[str, Any]) -> None:
    """Synchronous version for Ultralytics callbacks"""
    validation_base_url = self.base_url.replace('/training', '/validation')
    url = f"{validation_base_url}/jobs/{job_id}/results"

    with httpx.Client(timeout=30.0) as client:  # 동기 Client 사용
        response = client.post(url, json=data)
        response.raise_for_status()
```

**특징**:
- `httpx.AsyncClient` → `httpx.Client` 변경
- Tenacity retry 데코레이터 동일 적용 (최대 3회 재시도)
- Timeout 30초 (validation 데이터 전송에 충분)

### 구현 내용

#### 1. Frontend 동적 메트릭 차트 리팩토링
**파일**: `platform/frontend/components/training/MLflowMetricsCharts.tsx`
**변경사항**:
- Hardcoded 메트릭 키 제거
- 동적 카테고리 분류 로직 추가 (`categorizeMetric()`)
- 범용 `MetricChart` 컴포넌트 렌더링
- 커밋: `6ae8687`

#### 2. Backend Validation Callback API
**파일**:
- `platform/backend/app/api/validation.py` (lines 150-215)
- `platform/backend/app/schemas/validation.py` (lines 206-268)

**변경사항**:
- `POST /validation/jobs/{job_id}/results` 엔드포인트 추가
- `ValidationCallbackRequest` 스키마 정의
- `ValidationImageData` 스키마 정의
- Update-or-create 로직 구현
- 커밋: `935aafd`

#### 3. Ultralytics Trainer Validation 처리
**파일**:
- `platform/trainers/ultralytics/train.py` (lines 363-445)
- `platform/trainers/ultralytics/utils.py` (lines 207-265)

**변경사항**:
- Validation plots 자동 수집 및 MinIO 업로드
- Task type 자동 감지
- Class names 추출 (data.yaml)
- `send_validation_sync()` 메서드 추가
- Validation callback URL 라우팅 수정 (`/training` → `/validation`)
- 커밋: `f1d8834`

### E2E 테스트 결과 ✅

**테스트 시나리오**: Job 17 학습 실행 및 Validation Callback 검증

**검증 항목**:
1. ✅ 학습 완료 (2 epochs, yolov8n detection)
2. ✅ Validation plots 생성 (6개 PNG 파일)
3. ✅ MinIO Internal Storage 업로드:
   - `s3://training-checkpoints/job17/validation/confusion_matrix.png`
   - `s3://training-checkpoints/job17/validation/confusion_matrix_normalized.png`
   - F1_curve.png, PR_curve.png, P_curve.png, R_curve.png
4. ✅ ContentType 메타데이터 설정 (`image/png`)
5. ✅ Validation callback 전송:
   - URL: `POST /api/v1/validation/jobs/17/results`
   - Task type: `detection`
   - Primary metric: `mAP50-95`
   - Class names: 43 classes from data.yaml
   - Visualization URLs: 6 plots

**예상된 404 에러**:
- Job 17은 직접 trainer를 호출하여 생성 (Backend DB에 미존재)
- 실제 운영 시에는 Backend API로 job 생성 → trainer 호출 순서
- 404는 job 검증 로직이 정상 동작함을 의미

**로그 증적**:
```
2025-11-14 18:30:12,443 - __main__ - INFO - Processing validation results...
2025-11-14 18:30:12,528 - __main__ - INFO - Uploaded confusion_matrix.png → s3://...
2025-11-14 18:30:12,649 - __main__ - INFO - Uploaded confusion_matrix_normalized.png → s3://...
2025-11-14 18:30:15,008 - httpx - INFO - HTTP Request: POST .../validation/jobs/17/results "HTTP/1.1 404 Not Found"
```

### 다음 단계

#### Phase 3.4 완료 후 남은 작업
- [ ] **Frontend ValidationDashboard 통합 테스트**
  - Backend API를 통해 실제 job 생성
  - Validation 결과 조회 및 시각화 확인
  - Confusion matrix 클릭 인터랙션 테스트

- [ ] **Per-Image Validation Results**
  - 이미지별 예측 결과 저장 (optional)
  - Confusion matrix cell 클릭 시 해당 이미지 표시
  - Large dataset 대응 (페이지네이션)

- [ ] **Validation Metrics 확장**
  - Segmentation: IoU, Dice coefficient
  - Pose: OKS, PCK
  - Classification: Top-5 accuracy

#### Phase 3.5: Frontend 대시보드 통합
- [ ] MLflow 메트릭 + Validation 결과 통합 뷰
- [ ] 실시간 학습 진행 상황 표시
- [ ] Epoch별 메트릭 변화 추이 그래프
- [ ] Best epoch 자동 하이라이트

### 관련 문서
- [docs/planning/MVP_TO_PLATFORM_CHECKLIST.md](../planning/MVP_TO_PLATFORM_CHECKLIST.md) - Phase 3.4 체크리스트
- [platform/backend/app/schemas/validation.py](../../platform/backend/app/schemas/validation.py) - Validation 스키마 정의
- [platform/trainers/ultralytics/train.py](../../platform/trainers/ultralytics/train.py) - Trainer 구현

### 기술적 하이라이트

#### DualStorageClient 활용
```python
# Trainer는 단일 인터페이스 사용
storage = DualStorageClient()

# 자동 라우팅:
# - download_dataset() → External Storage (9000)
# - upload_checkpoint() → Internal Storage (9002)
storage.internal_client.client.upload_file(...)  # Direct S3 access when needed
```

#### Task Type Auto-Detection
```python
# 모델명에서 task type 추론
if 'seg' in model_name.lower():
    task_type = 'segmentation'
elif 'pose' in model_name.lower():
    task_type = 'pose'
elif 'cls' in model_name.lower():
    task_type = 'classification'
else:
    task_type = 'detection'  # Default
```

#### Callback URL Routing
```python
# /training → /validation 자동 변환
validation_base_url = self.base_url.replace('/training', '/validation')
url = f"{validation_base_url}/jobs/{job_id}/results"
# Result: POST /api/v1/validation/jobs/{id}/results
```
