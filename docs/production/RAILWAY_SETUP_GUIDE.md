# Railway 배포 가이드

Railway를 사용한 단계별 배포 가이드입니다.

---

## 사전 준비

### 1. Railway 계정
- https://railway.app 접속
- GitHub 계정으로 로그인
- 신용카드 등록 (무료 tier 사용 가능, $5 credit 제공)

### 2. GitHub Repository
- PR #11 merge 완료 확인
- `main` 브랜치에 최신 코드 반영

---

## 단계별 배포

### Step 1: Railway 프로젝트 생성

1. **Dashboard 접속**
   - https://railway.app/dashboard
   - "New Project" 클릭

2. **저장소 연결**
   - "Deploy from GitHub repo" 선택
   - `flytothejy/mvp-vision-ai-platform` 선택
   - Branch: `main`

3. **Root Directory 설정**
   - Railway가 자동으로 monorepo 감지
   - Frontend와 Backend 각각 설정 필요

---

### Step 2: PostgreSQL 추가

1. **Plugin 추가**
   - 프로젝트 대시보드에서 "+ New" 클릭
   - "Database" → "Add PostgreSQL" 선택

2. **자동 설정 확인**
   - `DATABASE_URL` 환경 변수 자동 생성
   - 연결 정보는 "Connect" 탭에서 확인 가능

3. **데이터베이스 정보**
   ```
   Host: <railway-provided>
   Port: <railway-provided>
   Database: railway
   User: postgres
   Password: <auto-generated>
   ```

---

### Step 3: Redis 추가

1. **Plugin 추가**
   - "+ New" → "Database" → "Add Redis"

2. **자동 설정 확인**
   - `REDIS_URL` 환경 변수 자동 생성

---

### Step 4: Backend 서비스 설정

1. **새 서비스 추가**
   - "+ New" → "GitHub Repo" → 동일 저장소 선택
   - Service Name: `backend`

2. **Root Directory 설정**
   - Settings → "Root Directory" → `mvp/backend` 입력

3. **Build 설정**
   - Settings → "Build" 섹션
   - Builder: `DOCKERFILE` (자동 감지)
   - Dockerfile Path: `Dockerfile`

4. **환경 변수 설정**
   - Settings → "Variables" 탭
   - 아래 변수들 추가:

   ```bash
   # LLM API (필수!)
   GOOGLE_API_KEY=<your-gemini-api-key>

   # Auth
   JWT_SECRET=<generate-random-64-char-string>
   JWT_ALGORITHM=HS256
   ACCESS_TOKEN_EXPIRE_MINUTES=60

   # CORS (Frontend URL은 나중에 업데이트)
   CORS_ORIGINS=http://localhost:3000

   # Dataset path (선택)
   DATASETS_PATH=/app/datasets

   # Port
   PORT=8000
   ```

   **JWT_SECRET 생성 방법:**
   ```bash
   # Python으로 생성
   python -c "import secrets; print(secrets.token_urlsafe(64))"

   # 또는 OpenSSL
   openssl rand -base64 64
   ```

5. **Health Check 설정**
   - Settings → "Health Check"
   - Path: `/health`
   - Timeout: 100초

6. **PostgreSQL & Redis 연결**
   - Settings → "Service Variables"
   - "Reference" 버튼 클릭
   - PostgreSQL의 `DATABASE_URL` 선택
   - Redis의 `REDIS_URL` 선택

---

### Step 5: Frontend 서비스 설정

1. **새 서비스 추가**
   - "+ New" → "GitHub Repo" → 동일 저장소 선택
   - Service Name: `frontend`

2. **Root Directory 설정**
   - Settings → "Root Directory" → `mvp/frontend` 입력

3. **Build 설정**
   - Builder: `NIXPACKS` (자동 감지)
   - Build Command: `npm run build` (자동)
   - Start Command: `npm run start` (자동)

4. **환경 변수 설정**
   - Backend 배포 완료 후 URL 확인 필요
   - Settings → "Variables" 탭

   ```bash
   # Backend URL (나중에 업데이트)
   NEXT_PUBLIC_API_URL=https://<backend-service>.up.railway.app/api/v1
   NEXT_PUBLIC_WS_URL=wss://<backend-service>.up.railway.app/ws
   ```

5. **Public Domain 설정**
   - Settings → "Networking"
   - "Generate Domain" 클릭
   - 생성된 URL 복사 (예: `frontend-production-xxxx.up.railway.app`)

---

### Step 6: 배포 순서

**중요**: 반드시 이 순서대로 배포!

#### 1) Backend 먼저 배포

1. **Trigger Deploy**
   - Backend 서비스 선택
   - "Deploy" 탭 → "Deploy Now" (또는 자동 배포 대기)

2. **Build Logs 확인**
   - "View Logs" 클릭
   - Dockerfile 빌드 과정 확인
   - 에러 발생 시 로그 확인

3. **배포 완료 확인**
   - Status: "Active" 확인
   - Health check 통과 확인
   - Domain 생성 (Settings → Networking → Generate Domain)

4. **Backend URL 복사**
   - 예: `https://backend-production-xxxx.up.railway.app`

#### 2) Frontend 환경 변수 업데이트

1. **Frontend 서비스 선택**
2. **Variables 탭**
3. **Backend URL 입력**
   ```bash
   NEXT_PUBLIC_API_URL=https://<backend-url>/api/v1
   NEXT_PUBLIC_WS_URL=wss://<backend-url>/ws
   ```

#### 3) Backend CORS 업데이트

1. **Backend 서비스 선택**
2. **Variables 탭**
3. **CORS_ORIGINS 업데이트**
   ```bash
   CORS_ORIGINS=https://<frontend-url>
   ```
4. **Redeploy** (환경 변수 변경 시 자동 재배포)

#### 4) Frontend 배포

1. **Frontend 서비스 선택**
2. **Deploy 탭 → Deploy Now**
3. **Build Logs 확인**
4. **배포 완료 대기**

---

### Step 7: 데이터베이스 초기화

#### Railway CLI 사용

```bash
# 1. Railway CLI 설치
npm install -g @railway/cli

# 2. 로그인
railway login

# 3. 프로젝트 연결
railway link
# → 프로젝트 선택: mvp-vision-ai-platform
# → 환경 선택: production

# 4. Backend 서비스 선택
railway service
# → backend 선택

# 5. Migration 실행
railway run alembic upgrade head
```

#### 웹 콘솔 사용 (더 간단!)

1. **Backend 서비스 선택**
2. **"Settings" → "Deploy"**
3. **"Custom Start Command" 섹션**
4. **Command 입력:**
   ```bash
   alembic upgrade head && uvicorn app.main:app --host 0.0.0.0 --port $PORT
   ```
5. **Redeploy**

---

### Step 8: 초기 사용자 생성

#### 방법 1: Railway Shell

```bash
# Railway CLI로 shell 접속
railway run bash

# Python 실행
python

# 사용자 생성 스크립트
from app.db.database import SessionLocal
from app.db.models import User
from app.core.security import get_password_hash

db = SessionLocal()
user = User(
    email="admin@example.com",
    username="admin",
    hashed_password=get_password_hash("ChangeMe123!"),
    is_active=True,
    is_superuser=True
)
db.add(user)
db.commit()
print(f"User created: {user.email}")
```

#### 방법 2: API 회원가입

프론트엔드에서 직접 회원가입 페이지 사용

---

## 배포 후 검증

### 1. Backend Health Check

```bash
curl https://<backend-url>/health
# 예상 응답: {"status": "ok"}
```

### 2. API Documentation

브라우저에서 접속:
```
https://<backend-url>/docs
```

Swagger UI가 표시되어야 함

### 3. Frontend 접속

```
https://<frontend-url>
```

로그인 페이지 또는 메인 페이지 표시 확인

### 4. 기능 테스트

- [ ] 회원가입 / 로그인
- [ ] 채팅 메시지 전송
- [ ] 기본 데이터셋 조회 (없으면 skip)
- [ ] 프로젝트 생성
- [ ] 학습 설정

---

## 트러블슈팅

### 문제 1: Backend 빌드 실패

**증상**: Dockerfile 빌드 중 에러

**해결**:
1. Logs에서 정확한 에러 확인
2. 주로 `requirements.txt` 의존성 문제
3. Railway 대시보드에서 "Redeploy" 시도

### 문제 2: Database 연결 실패

**증상**: `FATAL: password authentication failed`

**해결**:
1. PostgreSQL 서비스가 실행 중인지 확인
2. Backend에 `DATABASE_URL` 변수가 연결되었는지 확인
3. Settings → "Service Variables" → "Add Reference" → PostgreSQL

### 문제 3: Frontend에서 API 연결 안됨

**증상**: Network 탭에서 CORS 에러 또는 404

**해결**:
1. `NEXT_PUBLIC_API_URL` 값 확인 (trailing slash 없어야 함)
2. Backend `CORS_ORIGINS`에 Frontend URL 추가 확인
3. 환경 변수 변경 후 반드시 Redeploy

### 문제 4: 환경 변수가 반영 안됨

**증상**: 코드에서 `os.getenv()`가 None 반환

**해결**:
1. Variables 탭에서 변수 저장 확인
2. 변수 변경 후 **Redeploy 필수**
3. Logs에서 `Environment Variables` 섹션 확인

### 문제 5: Health Check 실패

**증상**: Service가 계속 재시작

**해결**:
1. `/health` 엔드포인트 구현 확인
2. Health Check Path 설정: `/health`
3. Timeout 늘리기 (100초)
4. Logs에서 startup 에러 확인

---

## 비용 모니터링

### Dashboard에서 확인

1. **Usage 탭**
   - 각 서비스별 리소스 사용량
   - 월별 예상 비용

2. **Billing**
   - 현재 credit 잔액
   - 사용 내역

### 비용 절감 팁

1. **Inactive Services 삭제**
   - 테스트 완료 후 불필요한 서비스 제거

2. **Sleep Mode**
   - Settings → "Sleep Settings"
   - 1시간 비활성 시 자동 sleep

3. **Database 최적화**
   - 불필요한 데이터 정리
   - Connection pool 설정

---

## 롤백 가이드

### 이전 배포로 복원

1. **Deployments 탭 접속**
2. **이전 성공한 배포 선택**
3. **"Rollback to this version" 클릭**
4. **확인**

### 환경 변수 복원

1. **Variables 탭**
2. **변경 전 값 입력**
3. **Save**
4. **Redeploy**

---

## 유용한 Railway CLI 명령어

```bash
# 프로젝트 상태 확인
railway status

# 로그 실시간 확인
railway logs

# 환경 변수 확인
railway variables

# 서비스 재시작
railway up

# Shell 접속
railway run bash

# 특정 명령 실행
railway run <command>
```

---

## 다음 단계

배포 완료 후:

1. **검증 테스트 실행**
2. **성능 모니터링** (Railway Metrics)
3. **문제 발견 시 이슈 기록**
4. **로컬 개발 환경으로 복귀**
5. **개선 사항 구현**

---

**작성일**: 2025-11-02
**업데이트**: 2025-11-02
